name: LibUDS CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  static-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker Image
        run: docker build -t libuds-test-env -f Dockerfile .
        
      - name: Run Static Analysis in Docker
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/app \
            -u $(id -u):$(id -g) \
            libuds-test-env \
            bash -c "cppcheck --enable=all --inline-suppr --error-exitcode=1 -I include src/ && find src include examples -name '*.c' -o -name '*.h' | xargs clang-format --dry-run --Werror"

  build-posix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker Image
        run: docker build -t libuds-test-env -f Dockerfile .
        
      - name: Run Build & Tests in Docker
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/app \
            -u $(id -u):$(id -g) \
            libuds-test-env \
            ./scripts/check_quality.sh
          
      - name: Archive Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-report
          path: build_quality/report.xml

  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker Image
        run: docker build -t libuds-test-env -f Dockerfile .
        
      - name: Run Coverage in Docker
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/app \
            -u $(id -u):$(id -g) \
            libuds-test-env \
            ./scripts/generate_coverage.sh
          
      - name: Archive Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build_coverage/coverage_report/

  build-zephyr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install West and Dependencies
        run: |
          python3 -m pip install --user -U west
          python3 -m venv .venv
          source .venv/bin/activate
          pip install -r scripts/requirements.txt
          
      - name: Initialize Zephyr
        run: |
          source .venv/bin/activate
          west init -m https://github.com/zephyrproject-rtos/zephyr --mr main zephyr-workspace
          cd zephyr-workspace
          west update
          west zephyr-export
          
      - name: Build Zephyr Example
        run: |
          source .venv/bin/activate
          export ZEPHYR_BASE=$GITHUB_WORKSPACE/zephyr-workspace/zephyr
          export ZEPHYR_MODULES=$GITHUB_WORKSPACE
          cd examples/zephyr_uds_server
          west build -b native_sim

  integration-tests:
    runs-on: ubuntu-latest
    # This job requires a custom runner or specialized action for SocketCAN support
    # For now, we define the structure.
    steps:
      - uses: actions/checkout@v4
      - name: Run Integration Tests (Placeholder)
        run: echo "Integration tests require SocketCAN/vcan environment."
