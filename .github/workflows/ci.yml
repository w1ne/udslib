name: LibUDS CI

on:
  push:
    branches: [ main, develop, 'release/*' ]
  pull_request:
    branches: [ main, develop, 'release/*' ]

jobs:
  static-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker Image
        run: docker build -t libuds-test-env -f Dockerfile .
        
      - name: Run Static Analysis in Docker
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/app \
            -u $(id -u):$(id -g) \
            libuds-test-env \
            bash -c "cppcheck --enable=all --suppress=missingIncludeSystem --suppress=unusedFunction --inconclusive --inline-suppr --error-exitcode=1 -I include src/ && find src include examples -name '*.c' -o -name '*.h' | xargs clang-format --dry-run --Werror"

  build-posix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker Image
        run: docker build -t libuds-test-env -f Dockerfile .
        
      - name: Run Build & Tests in Docker
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/app \
            -u $(id -u):$(id -g) \
            libuds-test-env \
            ./scripts/check_quality.sh
          
      - name: Archive Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-report
          path: build_quality/report.xml

  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker Image
        run: docker build -t libuds-test-env -f Dockerfile .
        
      - name: Run Coverage in Docker
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/app \
            -u $(id -u):$(id -g) \
            libuds-test-env \
            ./scripts/generate_coverage.sh
          
      - name: Archive Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build_coverage/coverage_report/

  build-zephyr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Cache Zephyr Workspace
        id: cache-zephyr
        uses: actions/cache@v4
        with:
          path: zephyr-workspace
          key: ${{ runner.os }}-zephyr-4.3.99-${{ hashFiles('scripts/requirements.txt') }}

      - name: Install West and Dependencies
        run: |
          python3 -m pip install --user -U west jsonschema
          python3 -m venv .venv
          source .venv/bin/activate
          pip install -r scripts/requirements.txt
          
      - name: Initialize Zephyr
        if: steps.cache-zephyr.outputs.cache-hit != 'true'
        run: |
          source .venv/bin/activate
          west init -m https://github.com/zephyrproject-rtos/zephyr --mr main zephyr-workspace
          cd zephyr-workspace
          west update --narrow -o=--depth=1
          west zephyr-export
          
      - name: Install Zephyr Python Dependencies
        run: |
          source .venv/bin/activate
          pip install -r zephyr-workspace/zephyr/scripts/requirements.txt

      - name: Build Zephyr Example
        run: |
          source .venv/bin/activate
          export ZEPHYR_BASE=$GITHUB_WORKSPACE/zephyr-workspace/zephyr
          export ZEPHYR_MODULES=$GITHUB_WORKSPACE
          cd examples/zephyr_uds_server
          west build -b native_sim

  integration-tests:
    runs-on: ubuntu-latest
    needs: build-posix
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker Image
        run: docker build -t libuds-test-env -f Dockerfile .

      - name: Build Integration Artifacts
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/app \
            -u $(id -u):$(id -g) \
            libuds-test-env \
            bash -c "set -euo pipefail
              cmake -S . -B build -DBUILD_TESTING=ON
              cmake --build build --target uds_host_sim test_integration
              make -C examples/client_demo"

      - name: Run C Integration Test (ctest)
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/app \
            -u $(id -u):$(id -g) \
            libuds-test-env \
            bash -c "cd build && ctest -R test_integration --output-on-failure"

      - name: Run Host Simulator Loopback
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/app \
            -u $(id -u):$(id -g) \
            libuds-test-env \
            bash -c "./run_integration_test.sh"

      - name: Run Python Integration Suite
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/app \
            -u $(id -u):$(id -g) \
            libuds-test-env \
            bash -c "python3 tests/integration/test_uds.py"

      - name: Archive Integration Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-logs
          path: |
            build/Testing
            sim_c.log
            client_c.log
