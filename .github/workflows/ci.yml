name: LibUDS CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  static-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker Image
        run: docker build -t libuds-test-env -f Dockerfile .
      - name: Run Static Analysis in Docker
        run: |
          ./scripts/docker_run.sh bash -c "cppcheck --enable=all --suppress=missingIncludeSystem --suppress=unusedFunction --suppress=unmatchedSuppression --inconclusive --inline-suppr --error-exitcode=1 -I include src/ && find src include examples -name '*.c' -o -name '*.h' | xargs clang-format --dry-run --Werror"

  build-posix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build and Test in Docker
        run: |
          ./scripts/docker_run.sh bash -c "mkdir -p build_quality && cd build_quality && cmake .. && make && ctest --output-on-failure"

  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate Coverage in Docker
        run: |
          ./scripts/docker_run.sh ./scripts/generate_coverage.sh
      - name: Upload Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build_coverage/coverage_report/

  build-zephyr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build and Initialize Zephyr in Docker
        run: |
          ./scripts/docker_run.sh bash -c "
            # Set up python environment
            python3 -m venv .venv_zephyr
            source .venv_zephyr/bin/activate
            pip install jsonschema west
            
            # Initialize workspace if not present (caching is handled by runner)
            if [ ! -d zephyr-workspace ]; then
              west init -m https://github.com/zephyrproject-rtos/zephyr --mr main zephyr-workspace
              cd zephyr-workspace
              west update --narrow -o=--depth=1
              west zephyr-export
              pip install -r zephyr/scripts/requirements.txt
              cd ..
            fi
            
            # Build example
            export ZEPHYR_BASE=\$PWD/zephyr-workspace/zephyr
            export ZEPHYR_SDK_INSTALL_DIR=/opt/zephyr-sdk
            export ZEPHYR_MODULES=\$PWD
            cd examples/zephyr_uds_server
            west build -b native_sim
          "

  integration-tests:
    runs-on: ubuntu-latest
    needs: build-posix
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker Image
        run: docker build -t libuds-test-env -f Dockerfile .

      - name: Build Integration Artifacts
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/app \
            -u $(id -u):$(id -g) \
            libuds-test-env \
            bash -c "set -euo pipefail
              cmake -S . -B build -DBUILD_TESTING=ON
              cmake --build build --target uds_host_sim test_integration
              make -C examples/client_demo"

      - name: Run C Integration Test (ctest)
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/app \
            -u $(id -u):$(id -g) \
            libuds-test-env \
            bash -c "cd build && ctest -R test_integration --output-on-failure"

      - name: Run Host Simulator Loopback
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/app \
            -u $(id -u):$(id -g) \
            libuds-test-env \
            bash -c "./run_integration_test.sh"

      - name: Run Python Integration Suite
        run: |
          docker run --rm \
            -v $GITHUB_WORKSPACE:/app \
            -u $(id -u):$(id -g) \
            libuds-test-env \
            bash -c "python3 tests/integration/test_uds.py"

      - name: Archive Integration Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-logs
          path: |
            build/Testing
            sim_c.log
            client_c.log
