name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libcmocka-dev
      
      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Build Docker Image
        run: |
          docker build -t libuds-test-env -f Dockerfile .
      
      - name: Run Tests & Coverage in Docker
        run: |
          # Run coverage script inside container
          # This builds project, runs tests, and generates reports in build_coverage/
          docker run --rm \
            -v $GITHUB_WORKSPACE:/app \
            -u $(id -u):$(id -g) \
            libuds-test-env \
            ./scripts/generate_coverage.sh
      
      - name: Parse Test Results
        id: results
        run: |
          # Results are in build_coverage/test-results.xml (from mounted volume)
          TOTAL=$(grep -oP 'tests="?\K[0-9]+' build_coverage/test-results.xml | head -1 || echo "0")
          FAILURES=$(grep -oP 'failures="?\K[0-9]+' build_coverage/test-results.xml | head -1 || echo "0")
          PASSED=$((TOTAL - FAILURES))
          
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILURES" >> $GITHUB_OUTPUT
      
      - name: Extract Coverage Stats
        id: coverage
        run: |
          # Helper to extract coverage from summary generated by script
          # We need to rerun summary on host or capture it. checking build_coverage/coverage_report/index.html or similar
          # generate_coverage.sh generates coverage.info. we can run lcov --summary on host if installed, 
          # or we can rely on what the script printed?
          # Actually, let's output the summary to a file in the script?
          # generate_coverage.sh doesn't output summary to file?
          # Let's check generate_coverage.sh content again...
          
          # We can just cat the index.html or rely on lcov summary if available.
          # But lcov might not be on runner.
          # Let's rely on the HTML report for full details and maybe a simple grep on *.info if possible?
          # Or, update generate_coverage.sh to write summary to file. 
          # I'll rely on what I have: I need coverage percentage.
          # I can grep it from build_coverage/coverage_report/index.html
          
          COVERAGE_HTML="build_coverage/coverage_report/index.html"
          if [ -f "$COVERAGE_HTML" ]; then
             # Extract line coverage from HTML (approximate)
             # usually: <td class="headerCovTableEntry">92.3 %</td>
             COVERAGE=$(grep -oP 'headerCovTableEntry">\K[0-9]+\.[0-9]+(?= %)' $COVERAGE_HTML | head -1 || echo "0.0")
             echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          else
             echo "coverage=0.0" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate release notes
        id: release_notes
        run: |
          ./scripts/generate_release_notes.sh ${{steps.version.outputs.version }} > release-notes.md
          
          # Append coverage info to release notes
          echo "" >> release-notes.md
          echo "---" >> release-notes.md
          echo "" >> release-notes.md
          echo "## Code Coverage" >> release-notes.md
          echo "" >> release-notes.md
          echo "**Line Coverage**: ${{ steps.coverage.outputs.coverage }}%" >> release-notes.md
          echo "" >> release-notes.md
          cat build_coverage/coverage_summary.txt >> release-notes.md
          echo "" >> release-notes.md
          echo "Full coverage report available in release artifacts." >> release-notes.md
      
      - name: Package coverage report
        run: |
          cd build_coverage
          tar -czf coverage-report.tar.gz coverage_report/
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: LibUDS ${{ steps.version.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: |
            build_coverage/examples/host_sim/uds_host_sim
            build_coverage/tests/unit_tests
            build_coverage/coverage-report.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload test results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ steps.version.outputs.version }}
          path: |
            build_coverage/test-results.xml
            build_coverage/coverage-report.tar.gz
          retention-days: 90
